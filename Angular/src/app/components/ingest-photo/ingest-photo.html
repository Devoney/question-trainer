<div class="ingest-photo">
	<h4>{{ 'ingestPhoto.title' | transloco }}</h4>
	<p class="ingest-photo-description">{{ 'ingestPhoto.description' | transloco }}</p>

	<div class="ingest-photo-form">
		<div class="form-row-full">
			<app-book-selector [showLabel]="true" [disabled]="isLoading" />
		</div>
		<div class="form-row-full">
			<app-chapter-selector [showLabel]="true" [disabled]="isLoading" />
		</div>
		@if (!hasChapterSelected) {
			<div class="selection-hint">{{ 'ingestPhoto.selectionHint' | transloco }}</div>
		}
		<div class="form-row-full">
			<input
				#fileInput
				type="file"
				accept="image/*"
				[disabled]="isLoading"
				(change)="onFileSelected($event)"
				hidden
			/>
			<mat-form-field appearance="outline" class="ingest-photo-field">
				<mat-label>{{ 'ingestPhoto.photoLabel' | transloco }}</mat-label>
				<input
					matInput
					[readonly]="true"
					[disabled]="isLoading"
					[value]="fileName"
					[placeholder]="'ingestPhoto.photoPlaceholder' | transloco"
					(click)="fileInput.click()"
				/>
				<button
					mat-button
					matSuffix
					type="button"
					[disabled]="isLoading"
					(click)="fileInput.click()"
				>
					{{ 'ingestPhoto.browseButton' | transloco }}
				</button>
			</mat-form-field>
			@if (photoPreviewUrl) {
				<div class="photo-preview">
					<img [src]="photoPreviewUrl" [alt]="'ingestPhoto.previewAlt' | transloco" />
				</div>
			}
		</div>
		<div class="form-row-full">
			<mat-form-field appearance="outline" class="ingest-photo-field">
				<mat-label>{{ 'ingestPhoto.pageLabelStatic' | transloco }}</mat-label>
				<input
					matInput
					type="text"
					[disabled]="isLoading"
					[(ngModel)]="pageNr"
					[placeholder]="'ingestPhoto.pagePlaceholder' | transloco"
				/>
			</mat-form-field>
		</div>
		<div class="form-row-full">
			<mat-form-field appearance="outline" class="ingest-photo-field">
				<mat-label>{{ 'ingestPhoto.instructionsLabel' | transloco }}</mat-label>
				<textarea
					matInput
					rows="2"
					[disabled]="isLoading"
					[(ngModel)]="additionalInstructions"
					[placeholder]="'ingestPhoto.instructionsPlaceholder' | transloco"
				></textarea>
			</mat-form-field>
		</div>
		@if (errorKey) {
			<div class="alert alert-danger" role="alert">{{ errorKey | transloco }}</div>
		}
		<div class="actions">
			<button
				mat-raised-button
				color="primary"
				type="button"
				(click)="generateQuestions()"
				[disabled]="!photoBase64 || isLoading || !hasChapterSelected"
			>
				@if (isLoading) {
					<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
					<span class="visually-hidden">Loading</span>
					{{ 'ingestPhoto.loading' | transloco }}
				} @else {
					{{ 'ingestPhoto.generateButton' | transloco }}
				}
			</button>
		</div>
		@if (errorDetails) {
			<div class="error-details" role="status">{{ errorDetails }}</div>
		}
		@if (isLoading || streamingText) {
			<div class="streaming-output" role="status">
				<div class="streaming-label">
					{{ 'ingestPhoto.streaming.label' | transloco }}
					<span class="streaming-stage">
						@if (streamingStage === 'ocr') {
							{{ 'ingestPhoto.streaming.ocr' | transloco }}
						} @else if (streamingStage === 'qa') {
							{{ 'ingestPhoto.streaming.qa' | transloco }}
						} @else {
							{{ 'ingestPhoto.streaming.waiting' | transloco }}
						}
					</span>
				</div>
				<pre class="streaming-text" #streamingTextRef>{{ streamingText }}</pre>
			</div>
		}
	</div>

	@if (generatedQuestions.length) {
		<div class="ingest-photo-preview">
			<div class="alert alert-info" role="status">
				{{ 'ingestPhoto.previewNotice' | transloco }}
			</div>
			<ul class="list-group">
				@for (item of generatedQuestions; track $index) {
					<li class="list-group-item">
						<div class="qa-header">
							<span class="qa-title">
								{{ 'ingestPhoto.itemLabel' | transloco:{ index: $index + 1 } }}
							</span>
							<button
								mat-stroked-button
								color="warn"
								class="small-button"
								type="button"
								[disabled]="isLoading"
								(click)="removeGeneratedQuestion($index)"
							>
								{{ 'buttons.remove' | transloco }}
							</button>
						</div>
						<div class="qa-body">
							<div class="qa-question" [innerHTML]="item.question"></div>
							<div class="qa-answer" [innerHTML]="item.answer"></div>
							@if (item.pageNr) {
								<div class="qa-page">
									{{ 'ingestPhoto.pageLabel' | transloco:{ pageNr: item.pageNr } }}
								</div>
							}
						</div>
					</li>
				}
			</ul>
			<div class="actions">
				<button mat-raised-button color="accent" type="button" (click)="addToLibrary()">
					{{ 'ingestPhoto.addButton' | transloco }}
				</button>
			</div>
		</div>
	}
</div>
